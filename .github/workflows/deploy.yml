name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          cache: false
          go-version-file: go.mod

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Build frontend
        run: |
          cd frontend
          npm install
          npm run build
          cd ..
          mkdir -p web/html
          rm -rf web/html/*
          cp -R frontend/dist/* web/html/

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-x86-64-linux-gnu

      - name: Build s-ui for Linux amd64
        run: |
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=amd64
          export CC=x86_64-linux-gnu-gcc

          echo "Building for Linux amd64 with CGO enabled"
          go version

          go build -ldflags="-w -s" -tags "with_quic,with_grpc,with_utls,with_acme,with_gvisor" -o sui main.go
          file sui
          chmod +x sui

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Ubuntu Server
        run: |
          scp -P ${{ secrets.SERVER_PORT }} sui ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/sui

      - name: Restart s-ui service
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            # Stop s-ui service
            sudo systemctl stop s-ui

            # Backup old binary
            sudo cp /usr/local/s-ui/sui /usr/local/s-ui/sui.backup.$(date +%Y%m%d_%H%M%S)

            # Replace with new binary
            sudo mv /tmp/sui /usr/local/s-ui/sui
            sudo chmod +x /usr/local/s-ui/sui

            # Start s-ui service
            sudo systemctl start s-ui

            # Check status
            sleep 3
            sudo systemctl status s-ui --no-pager

            echo "Deployment completed successfully!"
          ENDSSH
