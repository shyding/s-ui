name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          cache: false
          go-version-file: go.mod

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Build frontend
        run: |
          cd frontend
          npm install
          npm run build
          cd ..
          mkdir -p web/html
          rm -rf web/html/*
          cp -R frontend/dist/* web/html/

      - name: Build s-ui for Linux amd64
        run: |
          export CGO_ENABLED=0
          export GOOS=linux
          export GOARCH=amd64

          echo "Building for Linux amd64"
          go version

          go build -ldflags="-w -s" -tags "with_quic,with_grpc,with_utls,with_acme,with_gvisor" -o sui main.go
          file sui
          chmod +x sui

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Ubuntu Server
        run: |
          scp -P ${{ secrets.SERVER_PORT }} sui ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/sui
          scp -P ${{ secrets.SERVER_PORT }} s-ui.service ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/s-ui.service
          scp -P ${{ secrets.SERVER_PORT }} s-ui.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/s-ui.sh

      - name: Install or Update s-ui service
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            # Check if s-ui service exists
            if ! systemctl list-unit-files | grep -q "s-ui.service"; then
              echo "s-ui service not found, installing..."
              
              # Create installation directory
              sudo mkdir -p /usr/local/s-ui
              
              # Copy service file
              sudo cp /tmp/s-ui.service /etc/systemd/system/s-ui.service
              
              # Copy management script
              sudo cp /tmp/s-ui.sh /usr/local/s-ui/s-ui.sh
              sudo chmod +x /usr/local/s-ui/s-ui.sh
              
              # Reload systemd and enable service
              sudo systemctl daemon-reload
              sudo systemctl enable s-ui
              
              echo "s-ui service installed successfully!"
            else
              echo "s-ui service exists, updating..."
              # Stop s-ui service
              sudo systemctl stop s-ui || true
              
              # Backup old binary if exists
              if [ -f /usr/local/s-ui/sui ]; then
                sudo cp /usr/local/s-ui/sui /usr/local/s-ui/sui.backup.$(date +%Y%m%d_%H%M%S)
              fi
            fi

            # Replace with new binary
            sudo mv /tmp/sui /usr/local/s-ui/sui
            sudo chmod +x /usr/local/s-ui/sui

            # Clean up temp files
            rm -f /tmp/s-ui.service /tmp/s-ui.sh

            # Start s-ui service
            sudo systemctl start s-ui

            # Check status
            sleep 3
            sudo systemctl status s-ui --no-pager

            echo "Deployment completed successfully!"
          ENDSSH
